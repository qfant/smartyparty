$.fn.UploadImg=function(f){if(f.files&&f.files.length>0){f.imgList=[];f.imgNum=f.files.length;a(f.files);}if(f.element){this.off("change").on("change",function(){var g=this.files;
f.imgList=[];f.imgNum=g.length;a(g);});}function a(g){$.each(g,function(l,k){if(k.size&&k.size>f.mixsize){f.error("大小超过限制");this.value="";}else{if(f.type&&f.type.indexOf(k.type)<0){f.error("格式不正确");
this.value="";}else{var h=window.URL||window.webkitURL||window.mozURL;var j=h.createObjectURL(k);f.before(j);b(j,k,l);this.value="";}}});}function b(h,j,i){var k=null;
EXIF.getData(j,function(){EXIF.getAllTags(this);k=EXIF.getTag(this,"Orientation");});var g=new Image();g.src=h;g.onload=function(){var o=document.createElement("canvas");
var n=o.getContext("2d"),m,q;if(f.maxwidth&&this.width<f.maxwidth){m=this.width;q=this.height;}if(f.maxwidth&&this.width>f.maxwidth){m=f.maxwidth;q=m/this.width*this.height;
}if(!f.maxwidth){m=this.width;q=this.height;}if(navigator.userAgent.match(/iphone/i)&&k!=""&&k!=1){switch(k){case 6:e(this,"left",o,m,q);break;case 8:e(this,"right",o,m,q);
break;case 3:e(this,"right",o,m,q);e(this,"right",o,m,q);break;default:$(o).attr({width:m,height:q});n.drawImage(this,0,0,m,q);}}else{$(o).attr({width:m,height:q});
n.drawImage(this,0,0,m,q);}var l=o.toDataURL(j.type,(f.quality||0.8)*1);var p=j.name.substr(0,j.name.lastIndexOf("."));c(l,j.type,p,i);};}function c(g,j,i,h){var k=d(g,j);
var l=new FormData();l.append("upimage",k,"file_"+Date.parse(new Date())+".jpg");$.ajax({url:f.url,type:"post",data:l,async:true,cache:false,contentType:false,processData:false,success:function(m){m=JSON.parse(m);
f.imgList.push({index:h,code:m.code,name:i,url:m.result});if(f.imgNum==f.imgList.length){f.success(f.imgList);}},error:function(m){f.error(JSON.stringify(m));
}});}function d(h,l){var g=window.atob(h.split(",")[1]);var m=new ArrayBuffer(g.length);var j=new Uint8Array(m);for(var k=0;k<g.length;k++){j[k]=g.charCodeAt(k);
}return new Blob([m],{type:l});}function e(l,m,i,h,o){var g=0;var n=3;if(l==null){return;}var j=2;if(j==null){j=g;}if(m=="right"){j++;j>n&&(j=g);}else{j--;
j<g&&(j=n);}var k=j*90*Math.PI/180;var p=i.getContext("2d");switch(j){case 0:i.width=h;i.height=o;p.drawImage(l,0,0,h,o);break;case 1:i.width=o;i.height=h;
p.rotate(k);p.drawImage(l,0,-o,h,o);break;case 2:i.width=h;i.height=o;p.rotate(k);p.drawImage(l,-h,-o,h,o);break;case 3:i.width=o;i.height=h;p.rotate(k);
p.drawImage(l,-h,0,h,o);break;}}};